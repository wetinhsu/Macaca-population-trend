)) %>%
mutate(檢核 = str_replace(檢核, "NA、","")) %>%
#檢核座標----
filter(林管處 %in% "羅東") %>%
#  filter(工作站 %in% "鞍馬山") %>%
mutate(SP = paste0(Site_N, "_", Point)) %>%
split(., .$SP) %>%
lapply(., function(x){
tmp <-
Point_list %>%
filter(Site_N %in% x$Site_N & Point %in% x$Point)
x %>%
st_as_sf(., coords=c("TWD97_X", "TWD97_Y"), crs = 3826) %>%
mutate(DIST = st_distance(.,tmp) %>%
as.numeric() ) %>%
bind_cols(., as.data.frame(st_coordinates(.)))  %>%
st_drop_geometry()
}) %>%
bind_rows()
data3 <-
data1 %>%
mutate(檢核 = ifelse(DIST > 50, paste0(檢核, "、", "座標"), 檢核)) %>%
mutate(檢核 = str_replace(檢核, "NA、","")) %>%
select(`檢核`, `林管處`:`備註`, `X`:`Y`, `time`:`day_diff`, `DIST`) %>%
arrange(林管處, 工作站, Site_N, 月, 日, Point)
View(data3)
data1 <-
data0 %>%   setDT %>%
.[, "檢核" := NA] %>%
.[, c("年","月","日", "時", "分","數量") := lapply(.SD, function(x){as.numeric(x)}),
.SDcols =c("年","月","日", "時", "分","數量")] %>%
#回去查調查表的debug----
.[, 時 := ifelse(Site_N %in% "MA-D16-01" & Point %in% 5 & 月 %in% 3, 10, 時)] %>%
.[, 分 := ifelse(Site_N %in% "MA-D16-01" & Point %in% 5 & 月 %in% 3, 0, 分)] %>%
.[, 分 := ifelse(Site_N %in% "MA-D16-01" & Point %in% 6 & 月 %in% 3, 12, 分)] %>%
.[, 時 := ifelse(Site_N %in% "MA-D16-05" & Point %in% 6 & 月 %in% 5, 8, 時)] %>%
.[, 分 := ifelse(Site_N %in% "MA-H34-07" & Point %in% 5 & 月 %in% 3, 41, 分)] %>%
.[, 叫聲 := ifelse(Site_N %in% "MA-H33-15" & Point %in% 4 & 月 %in% 3, NA, 叫聲)] %>%
.[, 月 := ifelse(Site_N %in% "MA-B09-01" & `日` %in% 12, 5, 月)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-H32-04" & Point %in% 4 & 月 %in% 5, 2528482, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MB-H32-07" & Point %in% 6 & 月 %in% 6, 2526360, TWD97_Y)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-H31-01" & Point %in% 3 & 月 %in% 5, 243389, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-H34-07" & Point %in% 2 & 月 %in% 3, 286763, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-H33-15" & Point %in% 6 & 月 %in% 3, 252892, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MB-H33-06" & Point %in% 7 & 月 %in% 6, 262777, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MB-H33-06" & Point %in% 8 & 月 %in% 6, 262513, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MB-H33-06" & Point %in% 9 & 月 %in% 6, 262394, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MB-H33-02" & Point %in% 9 & 月 %in% 4, 265999, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-D16-02" & Point %in% 1 & 月 %in% 3, 231168, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-D16-02" & Point %in% 2 & 月 %in% 3, 231439, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-D16-02" & Point %in% 3 & 月 %in% 3, 231608, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-D16-02" & Point %in% 4 & 月 %in% 3, 231705, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-D16-02" & Point %in% 5 & 月 %in% 3, 231049, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-D16-02" & Point %in% 6 & 月 %in% 3, 230901, TWD97_X)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-02" & Point %in% 1 & 月 %in% 3, 2668460, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-02" & Point %in% 2 & 月 %in% 3, 2668506, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-02" & Point %in% 3 & 月 %in% 3, 2668680, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-02" & Point %in% 4 & 月 %in% 3, 2668881, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-02" & Point %in% 5 & 月 %in% 3, 2668817, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-02" & Point %in% 6 & 月 %in% 3, 2669015, TWD97_Y)] %>%
.[,  Point := ifelse(Site_N %in% "MA-D16-03"  & 月 %in% 3, 7-as.numeric(Point), Point)] %>%  #只是向反序而已
.[,  Point := ifelse(Site_N %in% "MA-D16-01"  , 7-as.numeric(Point), Point)] %>%  #只是向反序而已
.[,  Point := ifelse(Site_N %in% "MA-D16-09"  & Point %in% 6 , 6.5, Point)] %>%
.[,  Point := ifelse(Site_N %in% "MA-D16-09"  & Point %in% 5 , 6, Point)] %>%
.[,  Point := ifelse(Site_N %in% "MA-D16-09"  & Point %in% 4 , 5, Point)] %>%
.[,  Point := ifelse(Site_N %in% "MA-D16-09"  & Point %in% 6.5 , 4, Point)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-04" & Point %in% 6 & 月 %in% 3, 2654727, TWD97_Y)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-D16-04" & Point %in% 2 & 月 %in% 5, 226987, TWD97_X)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-04" & Point %in% 2 & 月 %in% 5, 2654409, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-D16-05" & Point %in% 1 & 月 %in% 3, 2654533, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-E22-11" & Point %in% 1 & 月 %in% 3, 2591511, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-H31-15" & Point %in% 3 & 月 %in% 3, 2461339, TWD97_Y)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-H31-13" & Point %in% 1 & 月 %in% 3, 232685, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-H33-14" & Point %in% 4 & 月 %in% 3, 273224, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-H32-06" & Point %in% 1 & 月 %in% 3, 253506, TWD97_X)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-H32-06" & Point %in% 1 & 月 %in% 3, 2519886, TWD97_Y)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-H32-06" & Point %in% 1 & 月 %in% 5, 253508, TWD97_X)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-H32-06" & Point %in% 1 & 月 %in% 5, 2519890, TWD97_Y)] %>%
#----
.[, TWD97_X := ifelse(Site_N %in% "MB-E19-13" & Point %in% 5 & 月 %in% 4, 242086, TWD97_X)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-E19-05" & Point %in% 6 & 月 %in% 3, 192832, TWD97_X)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MB-E20-01" & Point %in% 6 & 月 %in% 6, 2599713, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MB-E20-13" & Point %in% 5 & 月 %in% 4, 2599476, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MB-E21-12" & Point %in% 6 & 月 %in% 4, 2599012, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MB-E21-08" & Point %in% 2 & 月 %in% 6, 2587356, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-E22-09" & Point %in% 2 & 月 %in% 5, 2573844, TWD97_Y)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-E22-09" & Point %in% 4 & 月 %in% 5, 2573629, TWD97_Y)] %>%
.[, Point := replace(Point, Site_N %in% "MB-E19-12" & Point %in% c(4:6), 5:7)] %>%
.[, Point := replace(Point, Site_N %in% "MB-E19-13" & Point %in% c(4:5), 5:6)] %>%
.[, Point := ifelse(Site_N %in% "MA-E19-01" & Point %in% 5 & TWD97_X %in% 201521, 6, Point)] %>%
.[, Point := ifelse(Site_N %in% "MA-E19-01" & Point %in% 6 & TWD97_X %in% 201733, 5, Point)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-E19-03" & Point %in% 4 & 月 %in% 5, 2569182, TWD97_Y)] %>%
.[, TWD97_X := ifelse(Site_N %in% "MA-E19-03" & Point %in% 5 & 月 %in% 5, 185735, TWD97_X)] %>%
.[, TWD97_Y := ifelse(Site_N %in% "MA-E19-03" & Point %in% 5 & 月 %in% 5, 2569392, TWD97_Y)] %>%
.[, Point := replace(Point, Site_N %in% "MB-E20-12" & Point %in% c(2:5), 3:6)] %>%
.[, Point := replace(Point, Site_N %in% "MB-E20-08" & Point %in% c(4:6), 3:5)] %>%
.[, Point := replace(Point, Site_N %in% "MB-E20-11" & Point %in% c(1:4), 3:6)] %>%
.[, Point := replace(Point, Site_N %in% "MB-E21-07", c(4,3,2,1,6,5))] %>%
.[, Point := replace(Point, Site_N %in% "MA-E21-02" & Survey ==1 & Point %in% c(1:4), c(4,1,2,3))] %>%
.[, Point := replace(Point, Site_N %in% "MA-E21-02" & Survey ==2 & Point %in% c(1,4,5), c(5,1,4))] %>%
.[, Point := replace(Point, Site_N %in% "MB-E21-01" & Survey ==1 & Point %in% c(1,3), c(3,1))] %>%
.[, Point := replace(Point, Site_N %in% "MB-E21-12", c(5,3,4,6,2,1))] %>%
.[, Point := replace(Point, Site_N %in% "MA-E22-05" & 月 %in% 5 & Point %in% c(1,2), c(2,3))] %>%
.[, Point := replace(Point, Site_N %in% "MA-E22-03" & 月 %in% 5 & Point %in% c(1), c(2))] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-C12-12" & Point %in% 6 & 月 %in% 3, 2671255)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-C13-10" & Point %in% 1 & 月 %in% 4, 261183)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-C13-10" & Point %in% 1 & 月 %in% 6, 261183)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-C11-11" & Point %in% 5 & 月 %in% 6, 2683009)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-C11-08" & Point %in% 1 & 月 %in% 6, 2689011)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MC-C11-13" & Point %in% 5 & 月 %in% 6, 2686919)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-C12-11" & Point %in% 1 & 月 %in% 4, 248400)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-C12-11" & Point %in% 2 & 月 %in% 4, 248496)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-C12-11" & Point %in% 3 & 月 %in% 4, 248683)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-C12-11" & Point %in% 4 & 月 %in% 4, 248823)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-C12-11" & Point %in% 5 & 月 %in% 4, 249054)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-C12-11" & Point %in% 6 & 月 %in% 4, 249203)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-C12-11" & Point %in% 1 & 月 %in% 4, 2694909)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-C12-11" & Point %in% 2 & 月 %in% 4, 2694928)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-C12-11" & Point %in% 3 & 月 %in% 4, 2695070)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-C12-11" & Point %in% 4 & 月 %in% 4, 2695252)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-C12-11" & Point %in% 5 & 月 %in% 4, 2695206)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-C12-11" & Point %in% 6 & 月 %in% 4, 2695099)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-G30-11" & Point %in% 2 & 月 %in% 3, 2617742)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-G30-07" & Point %in% 1 & 月 %in% 3, 2615957)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-G30-02" & Point %in% 1 & 月 %in% 3, 2626852)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-G30-06" & Point %in% 5 & 月 %in% 3, 2618078)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-G30-12" & Point %in% 4 & 月 %in% 3, 306359)] %>%
.[, Point := replace(Point, Site_N %in% "MB-G30-01" & 月 %in% 6 & Point %in% c(1:6), c(6:1))] %>%
.[, Point := replace(Point, Site_N %in% "MA-G30-11" & 月 %in% 5 & Point %in% c(1,2,3,4,5,6), c(6,5,3,2,1,4))] %>%
.[, Point := replace(Point, Site_N %in% "MA-G30-02" & 月 %in% 5 & Point %in% c(3,5), c(5,3))] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-G30-07" & Point %in% 3 & 月 %in% 5, 300295)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-G30-07" & Point %in% 3 & 月 %in% 5, 2615873)] %>%
.[, Point := replace(Point, Site_N %in% "MA-G30-03" & 月 %in% 3 & Point %in% c(5,6), c(6,5))] %>%
.[, Point := replace(Point, Site_N %in% "MA-G29-04" & 日 %in% 7 & Point %in% c(3), c(4))] %>%
.[, Point := replace(Point, Site_N %in% "MA-G29-04" & 日 %in% 28 & Point %in% c(3), c(2))] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-A01-02" & Point %in% 3 & 月 %in% 5, 301314)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-A02-07" & Point %in% 5 & 月 %in% 5, 337834)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-A04-08" & Point %in% 4 & 月 %in% 3, 306272)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-A04-08" & Point %in% 4 & 月 %in% 5, 306272)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-A01-06" & Point %in% 6 & 月 %in% 4, 2721985)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-A01-06" & Point %in% 6 & 月 %in% 6, 293423)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-A01-06" & Point %in% 6 & 月 %in% 6, 2722004)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-A04-01" & Point %in% 6 & 月 %in% 5, 319995)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MB-A01-09" & Point %in% 6 & 月 %in% 4, 312210)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-A01-06" & Point %in% 5 & 月 %in% 4, 2721698)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MB-A01-06" & Point %in% 7 & 月 %in% 4, 2722138)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-A04-04" & Point %in% 1 & 月 %in% 3, 314761)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-A04-07" & Point %in% 1 & 月 %in% 5, 2749539)] %>%
.[, TWD97_X :=replace(TWD97_X, Site_N %in% "MA-A01-02" & Point %in% 3 & 月 %in% 3, 301354)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-A01-02" & Point %in% 3 & 月 %in% 3, 2715664)] %>%
.[, TWD97_Y :=replace(TWD97_Y, Site_N %in% "MA-A04-02" & Point %in% 1 & 月 %in% 3, 2738630)] %>%
#~debug----
mutate(time = ISOdatetime(年, 月,日,時,分, sec = 0) ) %>%
mutate(距離 = ifelse(數量==0 & (!is.na(距離)|距離 =="N") & (is.na(叫聲)|叫聲 =="N"), NA, 距離)) %>%
split(., .$Site_N) %>%
lapply(., function(x){  #檢核時間
x %>%
split(., .$Survey) %>%
lapply(., function(y){
y %>%
arrange(time) %>%
mutate(time_2=  c(time[2: n()], NA))%>%
mutate(time_diff = difftime(time_2, time, units='mins') %>%
as.numeric())  %>%
mutate(檢核 = ifelse(time_diff<6, "6分鐘", 檢核)) %>%
select(-time_2) %>%
mutate(day_diff = difftime(time[n()], time[1], units='days') %>%
as.numeric() %>% round(.,0))  %>%
mutate(檢核 = ifelse(day_diff > 7,
paste0(檢核, "、", "7日"), 檢核)) %>%
mutate(檢核 = ifelse(時 > 11,
paste0(檢核, "、", "太晚"), 檢核))
}) %>%
bind_rows()
}) %>%
bind_rows() %>%
mutate(檢核 = case_when(  #檢核獼猴調查填寫情形
數量 == 0 & !is.na(距離)  ~ paste0(檢核, "、", "距離"),
數量 == 0 & !(is.na(叫聲) | 叫聲 %in% "N") ~ paste0(檢核, "、", "叫聲"),
數量 %in% c(1,2) & is.na(距離)  ~ paste0(檢核, "、", "距離"),
數量 %in% c(1,2) & is.na(叫聲)  ~ paste0(檢核, "、", "叫聲"),
數量 %in% c(1) & !叫聲 %in% "N"  ~ paste0(檢核, "、", "叫聲"),
TRUE ~ 檢核
)) %>%
mutate(檢核 = str_replace(檢核, "NA、","")) %>%
#檢核座標----
filter(林管處 %in% "羅東") %>%
#  filter(工作站 %in% "鞍馬山") %>%
mutate(SP = paste0(Site_N, "_", Point)) %>%
split(., .$SP) %>%
lapply(., function(x){
tmp <-
Point_list %>%
filter(Site_N %in% x$Site_N & Point %in% x$Point)
x %>%
st_as_sf(., coords=c("TWD97_X", "TWD97_Y"), crs = 3826) %>%
mutate(DIST = st_distance(.,tmp) %>%
as.numeric() ) %>%
bind_cols(., as.data.frame(st_coordinates(.)))  %>%
st_drop_geometry()
}) %>%
bind_rows()
data3 <-
data1 %>%
mutate(檢核 = ifelse(DIST > 50, paste0(檢核, "、", "座標"), 檢核)) %>%
mutate(檢核 = str_replace(檢核, "NA、","")) %>%
select(`檢核`, `林管處`:`備註`, `X`:`Y`, `time`:`day_diff`, `DIST`) %>%
arrange(林管處, 工作站, Site_N, 月, 日, Point)
#------------------------------
library(leaflet)
buffer_Point <-
Point_list %>%
st_buffer(dist = 50)%>%
st_transform(4326)
#點位檢核----
df <-  data3 %>%
mutate(檢核補充說明 = "") %>%
mutate(Point = ifelse(Site_N %in% "MA-D16-05" & Point %in% 1, 7, Point)) %>%
mutate(檢核補充說明 = case_when(
Site_N == "MA-D16-05" & Point == 7 ~ "今年調查的樣點1與去年位置不同，(比較接近2019年設置的位置)，故改樣點代號為7",
Site_N == "MA-D16-04" & Point == 2 ~ "誤差大於50m，表訂的樣點2在森林步道上",
Site_N == "MA-H34-08" & Point == 5 & Survey %in% 1 ~ "誤差大於50m",
Site_N == "MA-H34-03" & Point == 2 & Survey %in% 1~ "照片判定兩旅次不在相同位置",
Site_N == "MA-H31-09" & Point == c(3,4) ~ "兩旅次照片相符，因為照片地點在既成道路上，可是表定樣點是點在100m的森林邊。(當初為了森林移了點，現在的位置在移點前)",
Site_N == "MA-H32-06" & Point == 1 ~ "需與調查人員再討論",
Site_N == "MB-E19-12" & Point == 2 ~ "需與調查人員確認，因兩旅次皆與表訂座標誤差大於50m",
Site_N == "MB-E19-13" & Point == 6 & X %in% c(242242, 242251)~ "需與調查人員確認，因為也不是樣點7的位置，若要成為新樣點距離也符合200m",
Site_N == "MA-E19-01" & Point == 5 & Survey %in% 2  ~ "與表訂座標誤差大於50m，因無第2旅次的GPS或環境照片所以無法證明是否是GPS誤差",
Site_N == "MA-E19-08" & Point == 4 & Survey %in% 2  ~ "與表訂座標誤差大於50m，因無第2旅次的GPS或環境照片所以無法證明是否是GPS誤差",
Site_N == "MA-E19-02" & Point == 4 & Survey %in% 1  ~ "與表訂座標誤差大於50m，因無第2旅次的GPS或環境照片所以無法證明是否是GPS誤差",
Site_N == "MA-E19-02" & Point == 6~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-03" & Point == 1~ "與表訂座標誤差大於50m，環境照片用街景確認過，調查位置不再表定位置",
Site_N == "MC-E20-05" & Point == 6~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-04" & Point == 1~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-04" & Point == 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-13" & Point == 3 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-13" & Point == 4 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-13" & Point == 5 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-01" & Point == 3~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-12" & Point == 6 & X %in% c(229299, 229304)~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 1 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 2 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 4 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 5 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 6 & Survey %in% 1~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-08" & Point == 1 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-08" & Point == 2 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-08" & Point == 3 & X %in% c(229883, 229793) ~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-11" & Point == 5 & X %in% c(229214, 229213) ~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-11" & Point == 6 & X %in% c(229102, 229101) ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-08" & Point == 6 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-06" & Point == 4 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-03" & Point == 4 & Survey %in% 1 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-03" & Point == 5 & Survey %in% 1 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E21-09" & Point == 4 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E21-11" & Point == 3 & Survey %in% 1 ~ "樣點3與樣點4的座標一模一樣，照片也模一樣",
Site_N == "MA-E21-11" & Point == 1 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E21-11" & Point == 2 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E21-11" & Point == 3 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-05" & Point == 1 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-05" & Point == 2 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-05" & Point == 5 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-10" & Point == 2 ~ "與表訂座標誤差大於50m，環境照片用街景確認過，調查位置不再表定位置",
Site_N == "MA-E22-10" & Point == 3 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-10" & Point == 5 & Survey %in% 1 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-05" & Point == 4 & Survey %in% 1 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-05" & Point == 3 & X %in% c(212492)~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-05" & Point == 5 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-05" & Point == 6 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-12" & Point == 6 ~ "與表訂座標誤差大於50m",
TRUE ~ 檢核補充說明)) %>%
mutate(檢核 = case_when(
Site_N == "MB-H33-04" & Point == 5 & Survey %in% 1~ str_replace(檢核, "、座標|^座標$", "") ,#位置相同，GPS機器誤差過大
Site_N == "MA-H33-12" & Point == 1 & Survey %in% 1~ str_replace(檢核, "、座標|^座標$", ""),#街景與照片相符，GPS機器誤差過大
Site_N == "MA-H32-08" & Point == 4 & Survey %in% 1~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MA-H32-08" & Point == 1 ~ str_replace(檢核, "^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MB-H33-02" & Point == 5 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MA-H33-13" & Point %in% c(1, 5) ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MA-C13-09" & Point %in% c(1)& Survey %in% 1 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MB-C13-10" & Point %in% c(5)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，調查表筆誤
Site_N == "MB-C13-11" & Point %in% c(4, 5)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，調查表筆誤
Site_N == "MA-C12-04" & Point %in% c(5)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，調查表筆誤
Site_N == "MA-G28-06" & Point %in% c(1)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MA-G28-12" & Point %in% c(4)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#50.多，給過吧
Site_N == "MB-A01-06" & Point %in% c(6)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#50.多，給過吧
Site_N == "MA-A01-02" & Point %in% c(1)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#50.多，給過吧
TRUE ~ 檢核)) %>%
#------
mutate(`TWD97_X` = `X`, `TWD97_Y` = `Y`) %>%
st_as_sf(., coords=c("X", "Y"), crs = 3826) %>%
st_transform(4326) %>%
bind_cols(., as.data.frame(st_coordinates(.)))  %>%
st_drop_geometry() %>%
mutate(X = as.numeric(X) %>% round(5), Y = as.numeric(Y) %>% round(5))
#output-----
path3 <- "//10.40.1.138/Bird Research/BBSTW (20170612)/15_計畫/臺灣獼猴族群監測計畫/與林務局合作/調查資料回傳/2021/1-初檢核/"
library(openxlsx)
df %>%
filter(檢核 %in% str_subset(`檢核`, "座標")) %>%
filter(Site_N %in% .$Site_N) %>%
select(Site_N) %>% unique() %>%
left_join(., df)%>%
filter(林管處 %in% "羅東") %>%
write.csv("D:/待處理工作夾(做完要歸檔)/Foresty2021_羅東.csv",row.names=F)
#點位檢核----
df <-  data3 %>%
mutate(檢核補充說明 = "") %>%
mutate(Point = ifelse(Site_N %in% "MA-D16-05" & Point %in% 1, 7, Point)) %>%
mutate(檢核補充說明 = case_when(
Site_N == "MA-D16-05" & Point == 7 ~ "今年調查的樣點1與去年位置不同，(比較接近2019年設置的位置)，故改樣點代號為7",
Site_N == "MA-D16-04" & Point == 2 ~ "誤差大於50m，表訂的樣點2在森林步道上",
Site_N == "MA-H34-08" & Point == 5 & Survey %in% 1 ~ "誤差大於50m",
Site_N == "MA-H34-03" & Point == 2 & Survey %in% 1~ "照片判定兩旅次不在相同位置",
Site_N == "MA-H31-09" & Point == c(3,4) ~ "兩旅次照片相符，因為照片地點在既成道路上，可是表定樣點是點在100m的森林邊。(當初為了森林移了點，現在的位置在移點前)",
Site_N == "MA-H32-06" & Point == 1 ~ "需與調查人員再討論",
Site_N == "MB-E19-12" & Point == 2 ~ "需與調查人員確認，因兩旅次皆與表訂座標誤差大於50m",
Site_N == "MB-E19-13" & Point == 6 & X %in% c(242242, 242251)~ "需與調查人員確認，因為也不是樣點7的位置，若要成為新樣點距離也符合200m",
Site_N == "MA-E19-01" & Point == 5 & Survey %in% 2  ~ "與表訂座標誤差大於50m，因無第2旅次的GPS或環境照片所以無法證明是否是GPS誤差",
Site_N == "MA-E19-08" & Point == 4 & Survey %in% 2  ~ "與表訂座標誤差大於50m，因無第2旅次的GPS或環境照片所以無法證明是否是GPS誤差",
Site_N == "MA-E19-02" & Point == 4 & Survey %in% 1  ~ "與表訂座標誤差大於50m，因無第2旅次的GPS或環境照片所以無法證明是否是GPS誤差",
Site_N == "MA-E19-02" & Point == 6~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-03" & Point == 1~ "與表訂座標誤差大於50m，環境照片用街景確認過，調查位置不再表定位置",
Site_N == "MC-E20-05" & Point == 6~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-04" & Point == 1~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-04" & Point == 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-13" & Point == 3 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-13" & Point == 4 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-13" & Point == 5 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-01" & Point == 3~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-12" & Point == 6 & X %in% c(229299, 229304)~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 1 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 2 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 4 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 5 & Survey %in% 2~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-07" & Point == 6 & Survey %in% 1~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-08" & Point == 1 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-08" & Point == 2 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-08" & Point == 3 & X %in% c(229883, 229793) ~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-11" & Point == 5 & X %in% c(229214, 229213) ~ "與表訂座標誤差大於50m",
Site_N == "MB-E20-11" & Point == 6 & X %in% c(229102, 229101) ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-08" & Point == 6 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-06" & Point == 4 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-03" & Point == 4 & Survey %in% 1 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-03" & Point == 5 & Survey %in% 1 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E21-09" & Point == 4 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E21-11" & Point == 3 & Survey %in% 1 ~ "樣點3與樣點4的座標一模一樣，照片也模一樣",
Site_N == "MA-E21-11" & Point == 1 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E21-11" & Point == 2 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E21-11" & Point == 3 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-05" & Point == 1 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-05" & Point == 2 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MB-E21-05" & Point == 5 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-10" & Point == 2 ~ "與表訂座標誤差大於50m，環境照片用街景確認過，調查位置不再表定位置",
Site_N == "MA-E22-10" & Point == 3 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-10" & Point == 5 & Survey %in% 1 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-05" & Point == 4 & Survey %in% 1 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-05" & Point == 3 & X %in% c(212492)~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-05" & Point == 5 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-05" & Point == 6 & Survey %in% 2 ~ "與表訂座標誤差大於50m",
Site_N == "MA-E22-12" & Point == 6 ~ "與表訂座標誤差大於50m",
TRUE ~ 檢核補充說明)) %>%
mutate(檢核 = case_when(
Site_N == "MB-H33-04" & Point == 5 & Survey %in% 1~ str_replace(檢核, "、座標|^座標$", "") ,#位置相同，GPS機器誤差過大
Site_N == "MA-H33-12" & Point == 1 & Survey %in% 1~ str_replace(檢核, "、座標|^座標$", ""),#街景與照片相符，GPS機器誤差過大
Site_N == "MA-H32-08" & Point == 4 & Survey %in% 1~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MA-H32-08" & Point == 1 ~ str_replace(檢核, "^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MB-H33-02" & Point == 5 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MA-H33-13" & Point %in% c(1, 5) ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MA-C13-09" & Point %in% c(1)& Survey %in% 1 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MB-C13-10" & Point %in% c(5)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，調查表筆誤
Site_N == "MB-C13-11" & Point %in% c(4, 5)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，調查表筆誤
Site_N == "MA-C12-04" & Point %in% c(5)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，調查表筆誤
Site_N == "MA-G28-06" & Point %in% c(1)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
Site_N == "MA-G28-12" & Point %in% c(4)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#50.多，給過吧
Site_N == "MB-A01-06" & Point %in% c(6)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#50.多，給過吧
Site_N == "MA-A01-02" & Point %in% c(1)& Survey %in% 2 ~ str_replace(檢核, "、座標|^座標$", ""),#50.多，給過吧
Site_N == "MA-A03-07" & Point %in% c(5)& Survey %in% 1 ~ str_replace(檢核, "、座標|^座標$", ""),#兩旅次照片相符，GPS機器誤差過大
TRUE ~ 檢核)) %>%
#------
mutate(`TWD97_X` = `X`, `TWD97_Y` = `Y`) %>%
st_as_sf(., coords=c("X", "Y"), crs = 3826) %>%
st_transform(4326) %>%
bind_cols(., as.data.frame(st_coordinates(.)))  %>%
st_drop_geometry() %>%
mutate(X = as.numeric(X) %>% round(5), Y = as.numeric(Y) %>% round(5))
df %>%
filter(檢核 %in% str_subset(`檢核`, "座標")) %>%
filter(Site_N %in% .$Site_N) %>%
select(Site_N) %>% unique() %>%
left_join(., df)%>%
filter(林管處 %in% "羅東") %>%
write.csv("D:/待處理工作夾(做完要歸檔)/Foresty2021_羅東.csv",row.names=F)
Point_list %>%
bind_cols(., as.data.frame(st_coordinates(.)))  %>%
st_drop_geometry() %>%
select(-Name) %>%
setNames(., c("Site_N", "Point", "樣點表_X", "樣點表_Y")) %>%
left_join(df, .) %>%
filter(林管處 %in% "羅東") %>%
select(
檢核,
林管處,
工作站,
"樣區名稱" = Name,
"樣區編號" = Site_N,
年,
月,
日,
調查者,
"旅次" = Survey,
"樣點代號" = Point,
TWD97_X,
TWD97_Y,
時,
分,
數量,
距離,
叫聲,
"棲地類型"  = Habitat,
備註,
樣點表_X,
樣點表_Y
) %>%
split(.$林管處) %>%
lapply(., function(x){
wb <- createWorkbook()
x %>%
split(., .$工作站) %>%
lapply(., function(y){
addWorksheet(wb, unique(y$工作站))
addFilter(wb,  sheet = unique(y$工作站), row = 1, cols = 2:ncol(y))
writeData(wb, sheet = unique(y$工作站), x = y, startCol = 3)
paste0("黃底色為需修正或再確認處。", "\n",
"藍底色為下次調查需改善處。", "\n",
"\n",
"\n",
"座標：請參考附件<樣點地圖>。", "\n",
"6分鐘：每個樣點需調查滿6分鐘。", "\n",
"7日：同一樣區同一旅次，需在7日內完成。", "\n",
"太晚：需在11點前完成調查。", "\n",
"叫聲：獼猴叫聲是猴群間溝通聯絡的聲音，表示附近有猴群。", "\n"
) %>%
writeData(wb, sheet = unique(y$工作站), x = .,startRow = 2, startCol = 1)
paste0( "檢核說明") %>%
writeData(wb, sheet = unique(y$工作站), x = .,startRow = 1, startCol = 1)
paste0( "工作站回覆") %>%
writeData(wb, sheet = unique(y$工作站), x = .,startRow = 1, startCol = 2)
saveWorkbook(wb,
paste0(path3,unique(y$林管處),"_初檢核_",format(Sys.Date(),"%m%d"),".xlsx"),
overwrite = TRUE)
})
})
setwd("D:/R/test/Macaca-population-trend")
######## Data Source:2015-2019 Macaca analisis ######
#---- load library
library(data.table)
library(magrittr)
library(readxl)
library(tidyr)
library(purrr)
library(dplyr)
library(writexl)
library(ggplot2)
#Original data----
M.data <- read_excel("./data/clean/for analysis_V1.xlsx",
sheet=1) %>% setDT %>%
#  .[analysis %in% "Y",] %>%
.[, TypeName.1 := ordered(TypeName.1,c("闊葉林",
"針葉林",
"混淆林",
"竹林",
"非森林"))] %>%
.[, County := ordered(County,
c("宜蘭縣","基隆市","台北市","臺北市",
"新北市","台北縣","臺北縣",
"桃園縣","桃園市","新竹市",
"新竹縣","苗栗縣",
"台中市","臺中市","台中縣","臺中縣",
"彰化縣","南投縣","南投市",
"雲林縣","嘉義縣","嘉義市",
"台南市","臺南市","台南縣","臺南縣",
"高雄縣","高雄市",
"屏東縣", "花蓮縣",
"台東縣","臺東縣"))]  %>%
.[, Year := as.numeric(Year)] %>%
.[, Survey := as.numeric(Survey)] %>%
.[, Point := as.numeric(Point)] %>%
.[, Macaca_sur := as.numeric(Macaca_sur)] %>%
.[, Month := as.numeric(Month)] %>%
.[, Day := as.numeric(Day)] %>%
.[, Distance := as.numeric(Distance)]
#--------------------------
Year.d <-
M.data %>%
.[analysis %in% "Y",] %>%
.[!(TypeName.1 %in% "非森林"),] %>%
.[is.na(Macaca_sur), Macaca_sur := 0] %>%
.[, .(V1 = sum(Macaca_sur),.N), by= list(Year, Survey)] %>%
.[, Encounter_rate := V1/N] %>%
.[, c("V1","N") :=NULL]
View(Year.d)
Year.d <-
M.data %>%
.[analysis %in% "Y",] %>%
.[!(TypeName.1 %in% "非森林"),] %>%
.[is.na(Macaca_sur), Macaca_sur := 0] %>%
.[, .(V1 = sum(Macaca_sur),.N), by= list(Year, Survey)] %>%
.[, Encounter_rate := V1/N]
Year.d %>%
.[,.(mean_N = sum(N)), by = list(Year)]
Year.d %>%
.[,.(mean_N = mean(N)), by = list(Year)]
