Macaca_sur = `數量`,
Macaca_dist = `距離`,
Macaca_voice = `叫聲`,
Habitat = `棲地類型(主要)`) %>%
mutate(Surveyor = gsub(",","、", Surveyor)) %>%
mutate(Surveyor = gsub(" ","", Surveyor)) %>%
mutate(Macaca_voice = gsub("n","N", .$Macaca_voice)) %>%
mutate(Macaca_voice = ifelse(Macaca_sur %in% 0 & Macaca_voice %in% c("N"), NA,  Macaca_voice)) %>%
mutate(Date = ISOdatetime(Year, Month, Day, Hour, Minute, sec = 0) ) %>%
mutate(Office = ordered(Office, c("羅東", "新竹", "東勢", "南投", "嘉義", "屏東", "花蓮", "臺東")))
DF %>%
filter(Macaca_sur %in% 0) %>%
filter(! is.na(Macaca_dist) | !is.na(Macaca_voice) )
DF %>%
filter( Macaca_sur %in% c(1, 2)) %>%
filter( is.na(Macaca_dist) | is.na(Macaca_voice) )
#確認旅次---
DF <-
DF %>%
reshape2::dcast(Year + Site_N ~ Survey, length, value.var = "Macaca_sur") %>%
#計算第1旅次及第2旅次調查的樣點數
filter(`1` %in% 0 & `2` >= 6) %>%  #找出有第2旅次沒第1旅次的樣區
left_join(DF, ., by = c("Year", "Site_N"))%>%
mutate( Survey = ifelse(!is.na(`1`),1, Survey)) %>%#將第1次調查的旅次改回1
select(-`1`, -`2`, -`NA`)
Count_Point_Survey <-
DF %>%
filter(!is.na(Macaca_sur) ) %>%
group_by(Office, Survey) %>%
summarise(Site_n = Site_N %>% unique %>% length,
Data_n = n()) %>%
reshape2::melt(id = 1:2) %>%
reshape2::dcast(Office ~ Survey + variable, guess_var = "value")
DF.2 <-
DF %>%
add_column(analysis = "Y", .before = "Office") %>%
mutate(SS = paste0(Site_N, "-", Survey)) %>%
split(.,.$SS) %>%
lapply(., function(x){  #計算調查時間間隔
x[order(x$Date),] %>%
mutate(time2 = NA) %>%
mutate(time2 = c(Date[2: length(Date)], NA)) %>%
mutate(time.diff = difftime(time2, Date, units ="mins")%>% as.numeric()) %>% #時間相隔，以分為單位
mutate(day.diff = difftime(time2, Date, units ="day"))  #時間相隔，以日為單位
}) %>%
lapply(., function(x){  #計算位置誤差距離：依樣區旅次分別計算各樣區內，各樣點離做近檢核點的距離
st_M.Point <-  #與st_DF對應的樣區
st_M.Point %>%
filter(Macaca_Site %in% unique(x$Site_N))
st_DF.2 <-
x %>%
mutate(SP = ifelse(!nchar(Point) %in% 1,
paste0(Site_N, "-0", Point),
paste0(Site_N, "-", Point))) %>%
mutate(X = as.numeric(TWD97_X)) %>%
mutate(Y = as.numeric(TWD97_Y)) %>%
st_as_sf(., coords = c("X", "Y"), crs = 3826)
st_DF.2$point_O <-
st_distance(st_DF.2, st_M.Point) %>%
apply(.,1,which.min) %>%
st_M.Point$樣區樣點編號[.]
st_DF.2$point.diff <-
st_distance(st_DF.2, st_M.Point) %>%
apply(., 1,min)
return(st_drop_geometry(st_DF.2))}) %>%
lapply(., function(x){     # 超過7日才完成調查，整個旅次的資料方棄
if(TRUE %in% (as.numeric(x$day.diff)>8)) x$analysis <- "N"
return(x)
})%>%
bind_rows() %>%
select(-SS) %>%   #刪除輔註欄位
mutate(analysis =case_when(analysis %in% "Y" & as.numeric(Hour) >= 11            ~ "N1",  #11點
analysis %in% "Y" & time.diff < 6 & !is.na(time.diff) ~ "N2",  #6分鐘
analysis %in% "Y" & point.diff > 50                   ~ "N3",  # range of gps =50m
analysis %in% "Y" & Point %in% "X"                    ~ "N3",  # range of gps =50m
TRUE ~ analysis))
DF.2 %>%  #各林管處的各疏失情況的樣點數
group_by(Office, analysis) %>%
summarise(N = n()) %>%
reshape2::dcast( analysis ~ Office, guess.var = "N")
DF.2 %>%   #林管處無疏失情形的樣點數
filter(!is.na(Macaca_sur) ) %>%
filter(analysis %in% "Y" ) %>%
group_by(Office, analysis, Survey) %>%
summarise(N = n()) %>%
reshape2::dcast( Office ~ analysis + Survey, guess.var = "N")
DF.2 %>%    #時無疏失情形下，林管處在1、2旅次的猴群、孤猴數
filter(analysis %in% "Y")  %>%
filter(!is.na(Macaca_sur) ) %>%
group_by(Office, Macaca_sur, Survey) %>%
summarise(N = n()) %>%
reshape2::dcast(Office + Survey ~ Macaca_sur, guess_value  = "N")
DF.2 %>%
filter(analysis %in% "Y")  %>%
filter(!is.na(Macaca_sur) ) %>%
left_join(st_drop_geometry(st_M.Point), by = c("point_O" = "樣區樣點編號") ) %>%
mutate(Macaca_sur = ifelse(Macaca_sur %in% "1" , 0,
ifelse(Macaca_sur %in% "2" , 1, Macaca_sur))) %>%
mutate(Macaca_sur = as.numeric(Macaca_sur)) %>%
group_by(Office, Macaca_sur, TypeName.1) %>%
summarise(N = n()) %>%
reshape2::dcast( Office + Macaca_sur ~ TypeName.1, guess.var = "N")
M.data <-
DF.2 %>%
filter(analysis %in% "Y")  %>%
filter(!is.na(Macaca_sur) ) %>%
left_join(st_drop_geometry(st_M.Point), by = c("point_O" = "樣區樣點編號") ) %>%
select(analysis, Office, Station,
"Site_N" = Macaca_Site,
"Point" = 樣點代號,
"X" = TWD97_X.y,
"Y" = TWD97_Y.y,
Year, Month, Day, Survey, Macaca_sur,
Hour, Minute, Day,
Macaca_dist,
Macaca_voice,
Habitat,
"Distance" = distance,
"TypeName" = join_TypeName, TypeName.1, Altitude)
#樣點資料檢核
#---- load library
library(tidyverse)
library(readxl)
library(writexl)
library(sf)
#------------
M.data <- read_excel("./data/clean/full_combind_Forestrydata_2021_V1.xlsx", sheet = "Data")%>%
select(-Macaca_voice, -Habitat ) %>%
mutate(Macaca_sur = ifelse(Macaca_sur %in% "1" , 0,    #孤猴改成0，猴群改成1
ifelse(Macaca_sur %in% "2" , 1, Macaca_sur))) %>%
mutate(Macaca_sur = ifelse(Macaca_dist %in% "C" , 0, Macaca_sur))
M.0<- M.data %>%
filter(Macaca_sur %in% 1)  #猴群
M.2<- M.0 %>%  #找出同一旅次同一樣區有猴群大於2者
group_by(Year, Survey, Site_N) %>%
summarise(N = n()) %>%
filter(N>1)
M.abc <- M.2 %>%
left_join(M.0) %>%   #幫M.2這樣區樣點加回座標等資訊
mutate(Y_S_S = paste0(Year, "_", Survey, "_",Site_N)) %>%
st_as_sf(., coords = c("X", "Y"), crs = 3826) %>%
split(., .$Y_S_S) %>%
lapply(., function(x){
dist <-
st_distance(x$geometry)    #算點與點間的距離
colnames(dist) <- x$Point         #加colnames
dist %>%
as.data.frame() %>%   #轉回長表格
setNames(., x$Point) %>%
add_column(Base_point = x$Point) %>%
reshape2::melt(id.vars = "Base_point", variable.name = "Nearest_point", value.name = "distance")%>%
filter(!distance %in% 0) %>%
arrange(Base_point)
}) %>%
bind_rows(.id = "Y_S_S") %>%
separate("Y_S_S", c("Year", "Survey","Site_N"), "_") %>%
mutate(distance = as.numeric(distance)) %>%
mutate(Nearest_point = Nearest_point %>% as.character() %>% as.numeric()) %>%
mutate(Base_point = as.numeric(Base_point))
(M.data.1 <-
M.data %>%
#exculde 重複記錄
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 1 & Site_N %in% "MA-A02-06" & Point %in% c(1,3),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 1 & Site_N %in% "MA-A05-01" & Point %in% c(4,6),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 1 & Site_N %in% "MA-F24-10" & Point %in% c(3),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 1 & Site_N %in% "MA-H31-15" & Point %in% c(4),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 1 & Site_N %in% "MA-H34-01" & Point %in% c(4),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 1 & Site_N %in% "MB-E20-04" & Point %in% c(3, 5),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 1 & Site_N %in% "MB-F25-05" & Point %in% c(6),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 1 & Site_N %in% "MB-H31-14" & Point %in% c(2),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 2 & Site_N %in% "MA-A05-01" & Point %in% c(2, 4, 6),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 2 & Site_N %in% "MA-E21-10" & Point %in% c(1, 4),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 2 & Site_N %in% "MA-H32-02" & Point %in% c(5),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 2 & Site_N %in% "MA-H34-12" & Point %in% c(2),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 2 & Site_N %in% "MB-A01-03" & Point %in% c(2),
0)) %>%
mutate(Macaca_sur = replace(Macaca_sur,
Year %in% 2021 & Survey %in% 2 & Site_N %in% "MB-G29-08" & Point %in% c(4),
0)) #exculde 重複記錄
)
View(M.data.1 )
remove.data  <-  #重複記錄的列表
M.data.1%>%
anti_join(M.data)
M.data %>%  #移除重複前
filter(Macaca_sur %in% 1) %>%
group_by(Year, Survey, Site_N) %>%
summarise(N = n()) %>%
.$N %>%
table
M.data.1 %>%   #移除重複前
filter(Macaca_sur %in% 1) %>%
group_by(Year, Survey, Site_N) %>%
summarise(N = n()) %>%
.$N %>%
table
M.data %>%  #移除重複前
filter(Macaca_sur %in% 1) %>%
group_by(Year, Survey, Site_N) %>%
summarise(N = n()) %>%
.$N %>%
table
#------------
M.data <- read_excel("./data/clean/full_combind_Forestrydata_2021_V1.xlsx", sheet = "Data")%>%
select(-Macaca_voice, -Habitat ) %>%
mutate(Macaca_sur = ifelse(Macaca_sur %in% "1" , 0,    #孤猴改成0，猴群改成1
ifelse(Macaca_sur %in% "2" , 1, Macaca_sur))) %>%
mutate(Macaca_sur = ifelse(Macaca_dist %in% "C" , 0, Macaca_sur))
M.0<- M.data %>%
filter(Macaca_sur %in% 1)  #猴群
M.2<- M.0 %>%  #找出同一旅次同一樣區有猴群大於2者
group_by(Year, Survey, Site_N) %>%
summarise(N = n()) %>%
filter(N>1)
M.data %>%  #移除重複前
filter(Macaca_sur %in% 1) %>%
group_by(Year, Survey, Site_N) %>%
summarise(N = n()) %>%
.$N %>%
table
M.data.1 <-
M.data.1 %>%
mutate(TypeName.1 = ordered(TypeName.1,c("闊葉林", "針葉林","混淆林","竹林","非森林"))) %>%
mutate(julian.D = ISOdatetime(Year, Month, Day, Hour, Minute, sec = 0) %>%
as.POSIXlt(format = "%yyyy%mm%dd") %>%
format(., "%j") %>% as.numeric())
M.data.2 <-
M.data.1 %>%
filter(Month >= 3 & Month <= 6) %>%   #刪除調查季(包含緩衝期)以外的資料
mutate(analysis = ifelse(TypeName.1 %in% "非森林" | Altitude<50, "N", analysis))
M.data.2 %>% filter(analysis %in% "Y") %>%  #看一下誰被刪掉
anti_join(M.data.1,.) %>% View
M.data.2 %>%
group_by(Year, Survey, Site_N, Point) %>%
summarise(N = n()) %>%
filter(N >1)
M.data.2 %>%
group_by(Year, Survey, Site_N, Point) %>%
summarise(N = n())
M.data.2 %>%
group_by(Year, Survey, Site_N, Point) %>%
summarise(N = n()) %>%
filter(N >1)
M.data.2 %>%
group_by(Year, Survey, Site_N, Point) %>%
summarise(N = n()) %>%
filter(N >1)
NOTE <- data.frame(說明 = "本資料集為已有刪減，僅留下可納入分析的資料。")
write_xlsx( list('NOTE' = NOTE, 'Data' = M.data.2), "./data/clean/for analysis Forestrydata_2021_V1.xlsx")
#樣點資料檢核
#---- load library
library(tidyverse)
library(readxl)
library(writexl)
library(sf)
M.data <-
read_excel("./data/clean/for analysis Forestrydata_2021_V1.xlsx",
sheet="Data")  %>%
#  bind_rows(
#  read_excel("./data/clean/for analysis Forestrydata_V1.xlsx",
#                     sheet="Data"))  %>%
mutate(Office = ordered(Office, c("羅東", "新竹", "東勢", "南投", "嘉義", "屏東", "花蓮", "臺東"))) %>%
mutate(Year = as.numeric(Year)) %>%
mutate(Survey = as.numeric(Survey)) %>%
mutate(Point = as.numeric(Point)) %>%
mutate(Month = as.numeric(Month)) %>%
mutate(Day = as.numeric(Day)) %>%
mutate(Macaca_sur = as.numeric(Macaca_sur)) %>%
mutate(Distance = as.numeric(Distance))
(Group_than2<- M.data %>%
filter(analysis %in% "Y") %>%
filter(!(TypeName.1 %in% "非森林")) %>%
filter(Macaca_sur %in% 1) %>%
group_by(Year, Survey, Site_N) %>%
summarise(N = n()) %>%
filter(N>1)
)
(Composition_Forest<- M.data %>%
filter(analysis %in% "Y") %>%
filter(!(TypeName.1 %in% "非森林")) %>%
group_by(TypeName.1,TypeName) %>%
summarise(N = n(), m = sum(Macaca_sur)))
#樣點資料檢核
#---- load library
library(tidyverse)
library(readxl)
library(writexl)
library(sf)
M.data <-
read_excel("./data/clean/for analysis Forestrydata_2021_V1.xlsx",
sheet="Data")  %>%
#  bind_rows(
#  read_excel("./data/clean/for analysis Forestrydata_V1.xlsx",
#                     sheet="Data"))  %>%
mutate(Office = ordered(Office, c("羅東", "新竹", "東勢", "南投", "嘉義", "屏東", "花蓮", "臺東"))) %>%
mutate(Year = as.numeric(Year)) %>%
mutate(Survey = as.numeric(Survey)) %>%
mutate(Point = as.numeric(Point)) %>%
mutate(Month = as.numeric(Month)) %>%
mutate(Day = as.numeric(Day)) %>%
mutate(Macaca_sur = as.numeric(Macaca_sur)) %>%
mutate(Distance = as.numeric(Distance))
(Group_than2<- M.data %>%
filter(analysis %in% "Y") %>%
filter(!(TypeName.1 %in% "非森林")) %>%
filter(Macaca_sur %in% 1) %>%
group_by(Year, Survey, Site_N) %>%
summarise(N = n()) %>%
filter(N>1)
)
(Composition_Forest<- M.data %>%
filter(analysis %in% "Y") %>%
filter(!(TypeName.1 %in% "非森林")) %>%
group_by(TypeName.1,TypeName) %>%
summarise(N = n(), m = sum(Macaca_sur)))
(E_rate_Office<-
M.data %>%
filter(analysis %in% "Y") %>%
filter(!(TypeName.1 %in% "非森林")) %>%
group_by(Year, Survey, Office) %>%
summarise(N = n(),
m = sum(Macaca_sur)) %>%
bind_rows(group_by(.,Year, Survey) %>%  #增加total的部分
summarise(N=sum(N), m = sum(m)) %>%
mutate(Office='Total')) %>%
mutate(E = m/N) %>%
ungroup() %>%
group_by(Office) %>%
summarise(Mean_N = mean(N),
Se_N = sd(N)/sqrt(n()),
Mean_m = mean(m),
Se_m = sd(m)/sqrt(n()),
Mean_E = mean(E),
Se_E = sd(E)/sqrt(n()))
)
tmp.forest <-
M.data %>%  #非森林的小計
filter(TypeName.1 %in%　"非森林") %>%
group_by(Year, Survey, TypeName.1) %>%
summarise(N = n(),
m = sum(Macaca_sur))
tmp.alt <-
M.data %>%  #<50m & >=50m 分別森林的小計
filter(!TypeName.1 %in%　"非森林") %>%
mutate(TypeName.1 = ifelse(Altitude<50, "less50","Forest")) %>%
group_by(Year, Survey, TypeName.1) %>%
summarise(N = n(),
m = sum(Macaca_sur))
(E_rate_Forest<-
M.data %>%
group_by(analysis, Year, Survey, TypeName.1) %>%
summarise(N = n(),
m = sum(Macaca_sur)) %>%
bind_rows(group_by(.,Year, Survey) %>% #增加total的部分，total的資料包含非森林及<50m
summarise(N=sum(N), m = sum(m)) %>%
mutate(TypeName.1='Total', analysis ="Y")) %>%
filter(analysis =="Y") %>%   #移除 非森林及<50m
select(-analysis)%>%
bind_rows(., tmp.alt, tmp.forest) %>%  #增加是先算好 森林、非森林、<50的小計
mutate(E = m/N) %>%
ungroup() %>%
group_by(TypeName.1) %>%
summarise(Mean_N = mean(N),
Se_N = sd(N)/sqrt(n()),
Mean_m = mean(m),
Se_m = sd(m)/sqrt(n()),
Mean_E = mean(E),
Se_E = sd(E)/sqrt(n()))
)
M.data_notForest <-
M.data %>%
filter(TypeName.1 %in% "非森林") %>%
mutate(cut = cut(Distance, breaks = seq(20,240,10),
include.lowest = T, right = TRUE))
#非森林的樣點離森林的距離
ggplot(M.data_notForest, aes(x = Distance))+
geom_histogram(fill = gray(0.8), col = "black", breaks = seq(20,240,10))+
stat_bin( geom="text", colour="black", size=3.5, breaks = seq(20,240,10),
aes(label=..count.., y=(..count..)+0.6))+
scale_x_continuous(breaks = seq(20,240,20),expand = c(0,0,0,5))+
scale_y_continuous(expand = c(0,0,0,5))+
labs(x = "Distance", y = "Count")+
theme(
text = element_text(family="serif"),
panel.grid = element_blank(),
panel.background = element_blank(),
axis.text = element_text(size = 14,colour = "black"),
axis.title = element_text(size = 18,colour = "black",
vjust = -2, hjust = 0.5)
)
#----------
#林管處的Encounter_rate
M.data %>%
filter(analysis %in% "Y") %>%
group_by(Office, Survey, Year) %>%
summarise(E = sum(Macaca_sur)/n()) %>%
ggplot(., aes(x = Office, y = E)) +
geom_boxplot(size = 1, width = 0.4, fill= gray(.9))+
scale_y_continuous(breaks = seq(0,0.15,0.05), limits = c(0,0.15))+
labs(x = "林管處", y = "Encounter_rate")+
theme(
text = element_text(family="serif"),
panel.border = element_rect(size = 1.5,fill = NA),
panel.grid = element_blank(),
panel.background = element_blank(),
axis.text = element_text(size = 14,colour = "black"),
axis.title = element_text(size = 18,colour = "black",
vjust = -2, hjust = 0.5)
)
#-----------
#TypeName.1的Encounter_rate
M.data %>%
filter(analysis %in% "Y") %>%
group_by(TypeName.1, Survey, Year) %>%
summarise(E = sum(Macaca_sur)/n()) %>%
ggplot(., aes(x = TypeName.1, y = E)) +
geom_boxplot(size = 1, width = 0.4, fill= gray(.9))+
scale_y_continuous(breaks = seq(0,0.15,0.05), limits = c(0,0.15))+
labs(x = "森林類型", y = "Encounter_rate")+
theme(
text = element_text(family="serif"),
panel.border = element_rect(size = 1.5,fill = NA),
panel.grid = element_blank(),
panel.background = element_blank(),
axis.text = element_text(size = 14,colour = "black"),
axis.title = element_text(size = 18,colour = "black",
vjust = -2, hjust = 0.5)
)
#-----------
#Altitude的Encounter_rate
Alt.d.n <-
M.data %>%
filter(analysis %in% "Y") %>%
mutate(Altitude_f =cut(Altitude,
breaks = c(seq(0,4000,500)),
labels = c(seq(250,3750,500)),
include.lowest = T) ) %>%
group_by(Altitude_f,Survey, Year) %>%
summarise(N = n(), E = sum(Macaca_sur)/n()) %>%
group_by(Altitude_f) %>%
summarise(mean_N = mean(N),  y = quantile(E,0.75))
M.data %>%
filter(analysis %in% "Y") %>%
mutate(Altitude_f =cut(Altitude,
breaks = c(seq(0,4000,500)),
labels = c(seq(250,3750,500)),
include.lowest = T) ) %>%
group_by(Altitude_f,Survey, Year) %>%
summarise(E = sum(Macaca_sur)/n()) %>%
ggplot(., aes(x = Altitude_f, y = E)) +
geom_boxplot(size = 1, width = 0.4, fill= gray(.9))+
geom_text(data = Alt.d.n, aes(y = y+0.0025,label = paste0(mean_N,c("","","","","","",""))),
size = 4,
hjust = -0.1,
position = position_dodge(0.9))+
scale_y_continuous(breaks = seq(0,0.10,0.02), limits = c(0,0.10))+
labs(x = "Elevation (m)", y = "Encounter rate (troop/point)") +
theme(
text = element_text(family="serif"),
panel.border = element_rect(size = 1.5,fill = NA),
panel.grid = element_blank(),
panel.background = element_blank(),
axis.text = element_text(size = 14,colour = "black"),
axis.title = element_text(size = 18,colour = "black",
vjust = -2, hjust = 0.5)
)
M.data %>%
filter(analysis %in% "Y") %>%
mutate(Altitude_f =cut(Altitude,
breaks = c(seq(0,4000,500)),
labels = c(seq(250,3750,500)),
include.lowest = T) ) %>%
group_by(Altitude_f,Survey, Year) %>%
summarise(E = sum(Macaca_sur)/n()) %>%
group_by(Altitude_f) %>% #確認中位數
summarise(mid = median(E))
M.data %>%
filter(analysis %in% "Y") %>%
mutate(Altitude_f =cut(Altitude,
breaks = c(seq(0,4000,50)),
labels = c(seq(25,4000,50)),
include.lowest =T) ) %>%
group_by(Altitude_f, Year) %>%
summarise(N = n()) %>%
#   mutate(Altitude_f = Altitude_f %>% as.character() %>% as.numeric()) %>%
ggplot(., aes(x = Altitude_f, y = N))+
geom_point()
