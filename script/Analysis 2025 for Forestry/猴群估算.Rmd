---
title: '20250901-猴群數估算'
output: word_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
	fig.asp = 1,
	fig.width = 6)

library(tidyverse)
library(readxl)
library(writexl)
library(sf)
library(here)
library(DBI)
library(data.table)
 library(flextable)
library(RColorBrewer)
library(showtext)
showtext_auto()
```


```{r}

con <-  dbConnect(RSQLite::SQLite(), dbname="D:/R/test/DB/P_BBS.db")
list_Point<-
  dbReadTable(con, "list_Point") %>% 
  arrange(樣區編號, 獼猴樣區編號,as.numeric(樣點代號)) 
list_Site<-
  dbReadTable(con, "list_Site") 
table_point<-
  dbReadTable(con, "table_point") 

dbDisconnect(con)
```


```{r}

forest_town<- read_xlsx(
  here("Report of Foresty_20251127/合併估算/鄉鎮內50m以上的森林面積.xlsx")) %>% 
  select(-perimeter) %>% 
  mutate(area = area/1000000) %>%   #換成km2
setDT
```


```{r}
se <- function(x){sd(x)/sqrt(length(x))}
```


# **BBS**

```{r include=FALSE}

M.data <- read_excel(here("./data/clean/for analysis_1524.xlsx"),
                     sheet=1) %>% 
  filter(analysis %in% "Y") %>%
  mutate_at(c("Year", "Survey", "Point", "Macaca_sur",
              "Month", "Day", "Distance"), as.numeric)
```

相對密度(群/樣點)圖

```{r include=FALSE}

E_year <-
M.data %>% 
  setDT %>% 
  .[, .(N = length(Macaca_sur),
        m = sum(Macaca_sur, na.rm=T)
        ),
   by =  c('Year', 'Survey')] %>% 
  .[,Encounter_rate := m/N] %>% 
  
  .[, .(
    Mean_N = mean(N)%>% round(3),
    SD_N = se(N) %>% round(3),
    Mean_m = mean(m)%>% round(3),
    SD_m = se(m) %>% round(3),
    Mean_E = mean(Encounter_rate)%>% round(3),
    SD_E = se(Encounter_rate) %>% round(3)),
  by =  c('Year')] 




```



```{r echo=FALSE}
p <- 
ggplot(E_year, aes(x = Year, y = Mean_E))+
  geom_point()+
  geom_line()+
  labs(y = "(相對密度)")+
  theme_classic()

```



```{r include=FALSE}
df <- 
  M.data %>% 
  .[is.na(Macaca_sur), Macaca_sur := 0] %>% 
  .[, Year := as.numeric(Year)] %>% 
  setDT %>% 
  .[!(TypeName.1 %in% "非森林"), ]%>% 
  right_join(list_Site[,c('SiteID', '樣區編號','獼猴樣區編號')], .,
             by = c("樣區編號" = "Site_N")) 

#bootstrap-------------------------
bb<- df %>% setDT %>% 
  .[, A := ifelse(Macaca_dist %in% "A", Macaca_sur,0)] %>% 
  .[, AB := ifelse(Macaca_dist %in% c("A","B"), Macaca_sur,0)]

#A僅使用25m內的猴群
#AB使用100m內的猴群

```


\newpage


# **林業署**

```{r include=FALSE}

M.data_F <- 
  here("./data/clean/Forestry/for analysis/") %>% 
  list.files(., full.names = T) %>% 
  str_subset(paste0(2020:2025)) %>% #如果只要2020~2022年，就寫2020:2022
  lapply(., read_excel, sheet="Data", col_types = "text") %>% 
  bind_rows() %>% 

  mutate_at(c("Year", "Survey","Month",
              "Day", "Macaca_sur", "Distance", "Altitude", "julian.D"), as.numeric) %>% 
  filter(analysis %in% "Y") %>% 
  filter(Year > 2020) %>% 
  mutate_at(c("Year"), as.integer)%>% 
  mutate(Site_N = str_replace_all(Site_N,"MB-C11-10","MA-C11-10"))
```

相對密度(群/樣點)圖

```{r include=FALSE}

E_year_F <-
M.data_F %>% 
  setDT %>% 
  .[, .(N = length(Macaca_sur),
        m = sum(Macaca_sur, na.rm=T)
        ),
   by =  c('Year', 'Survey')] %>% 
  .[,Encounter_rate := m/N] %>% 
  
.[, .(
    Mean_N = mean(N)%>% round(3),
    SD_N = se(N) %>% round(3),
    Mean_m = mean(m)%>% round(3),
    SD_m = se(m) %>% round(3),
    Mean_E = mean(Encounter_rate)%>% round(3),
    SD_E = se(Encounter_rate) %>% round(3)),
  by =  c('Year')]  

```


```{r echo=FALSE}
library(RColorBrewer)

E_year_F %>% mutate(data_source = "Foresty") %>% 
  bind_rows(E_year %>% mutate(data_source = "BBS")) %>% 
ggplot(data = ., aes(x = Year, y = Mean_E))+
  geom_point(aes(col = data_source))+
  geom_line(aes(col = data_source))+
geom_errorbar(
  aes(x =Year,
      ymin = Mean_E-SD_E,
      ymax = Mean_E+SD_E,
      col = data_source), width = 0.1)+
  
  scale_color_brewer(palette = "Set2")+
  scale_x_continuous(breaks = 2015:2025,
                     labels = c(2015,"",2017,"",2019,"",2021,"",2023,"",2025))+
  scale_y_continuous(breaks = seq(0,0.05,0.01), limits = c(0,0.05))+
  labs(x = "", y = "Encounter_rate(群/樣點)")+
  theme_classic()+
  theme(text = element_text(size = 18),
        axis.title.y = element_text(angle = 270),
        legend.position = "top")

```

相對密度(群/樣點)  
```{r}
combine_bb_outout <-
E_year_F %>% mutate(data_source = "Foresty") %>% 
  bind_rows(E_year %>% mutate(data_source = "BBS"))

combine_bb_outout
```



```{r}
combine_bb_outout %>%
write_xlsx(
.,
  here("./Report of Foresty_20251127/合併估算/年的相對密度.xlsx")
) 
  

```



```{r include=FALSE}
df_F <- 
  M.data_F %>% 
  .[is.na(Macaca_sur), Macaca_sur := 0] %>% 
  .[, Year := as.numeric(Year)] %>% 
  .[, Office := ifelse(Office == "東勢", "臺中", Office)] %>% 
  .[, Office := ifelse(Office == "羅東", "宜蘭", Office)] %>% 
  setDT %>% 
  .[!(TypeName.1 %in% "非森林"), ]%>% 
  right_join(list_Site[,c('SiteID', '樣區編號','獼猴樣區編號')], .,
             by = c("獼猴樣區編號" = "Site_N")) 

#bootstrap-------------------------
bb_F<- df_F %>% setDT %>% 
  .[, A := ifelse(Macaca_dist %in% "A", Macaca_sur,0)] %>% 
  .[, AB := ifelse(Macaca_dist %in% c("A","B"), Macaca_sur,0)]

#A僅使用25m內的猴群
#AB使用100m內的猴群

```


#合併檢測--------------

合併及擷取2021~2024的資料  
```{r}
combine_bb <- 
bb_F %>% 
  select(SiteID,Year, 樣區編號,獼猴樣區編號, Point, Survey, Macaca_sur, Macaca_dist,AB) %>% 
  mutate(data_source = "Foresty") %>% 
  bind_rows(
    bb %>% 
      select(SiteID,Year, 樣區編號,獼猴樣區編號, Point, Survey,
         Macaca_sur, Macaca_dist,AB)%>%
      mutate(data_source = "BBS") %>% 
      mutate(Point = Point %>% as.character())  %>% 
      anti_join(bb_F[, c('SiteID','Year')],
                by = c('SiteID','Year'))
    ) %>% 
  filter(Year %in% c(2021:2024))
```

藍色數字為平均樣區數
```{r}

combine_bb %>% 
  setDT %>% 
  .[, .(N = length(Macaca_sur),
        m = sum(Macaca_sur, na.rm=T)
        ),
   by =  c('Year', 'Survey')] %>% 
  .[,Encounter_rate := m/N] %>% 
  .[, Mean_N := mean(N),   by =  c('Year')] %>% 
  
  ggplot(., aes(x = as.character(Year), y = Encounter_rate))+
  geom_boxplot(width = 0.3, linewidth = 0.4, fill= gray(.9))+
  stat_summary(fun = mean, geom = "text", 
               aes(label = round(Mean_N, 2)),
               hjust = -0.5,
               vjust = -3.2, color = "blue")+
  

  scale_y_continuous(breaks = seq(0,0.05,0.01), limits = c(0,0.05))+
  labs(x = "", y = "Encounter_rate(群/樣點)")+
  theme(
    panel.border = element_rect(size = 1.5,fill = NA),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.text = element_text(size = 20,colour = "black"),
    axis.title = element_text(size = 18,colour = "black"),
    axis.title.y = element_text(angle = 270,
                                vjust = -1, hjust = 0.5),
    legend.position = "top"
  )
```
```{r}
combine_bb %>% 
  setDT %>% 
  .[, .(N = length(Macaca_sur),
        m = sum(Macaca_sur, na.rm=T)
        ),
   by =  c('Year', 'Survey', 'data_source')] %>% 
  .[,Encounter_rate := m/N] %>% 
  .[, Mean_N := mean(N),   by =  c('Year','data_source')] %>% 
  
  ggplot(., aes(x = as.character(Year), y = Encounter_rate))+
  geom_boxplot( aes(fill= data_source))
```



```{r include=FALSE}
combine_bb %>%
  
  group_by(Year, SiteID, Point, Survey) %>% 
  summarise(n = n()) %>% 
  filter(n>1) %>% select(-n) %>% 
  left_join(list_Site, by = "SiteID")
  

#移除匯入BBS調查資料的林保署鳥類調查樣區( = 重複的資料)
```


```{r}

combine_bb %>% 
  left_join(table_point[,c('SiteID', "樣點代號",'X_97','Y_97')],
            by = c("SiteID", "Point" = "樣點代號"))%>%
write_xlsx(
.,
  here("./Report of Foresty_20251127/合併估算/troops_2021-2024.xlsx")
)

```



```{r}
path <- "D:/R/SHP圖層"

town <- st_read(paste0(path,"/","鄉(鎮、市、區)界線(TWD97經緯度)1131028/TOWN_MOI_1131028.shp"), crs=4326) %>% 
  st_transform(crs=3826)


summary(town)


```


```{r}
town_list_Point <- 
list_Point %>% 
  filter(!is.na(X_97)) %>% 
  st_as_sf(., coords = c("X_97", "Y_97"), crs = 3826) %>% 
  st_join(.,town) %>% 
  st_drop_geometry()

town_combine_bb <- 
town_list_Point %>% 
  right_join(.,combine_bb,
             by = c("樣區編號","獼猴樣區編號", "樣點代號"="Point")) 

```


#2021~2024年的調查資料



```{r}
summary__combine <- 
town_combine_bb %>% 
  group_by( Year, Survey) %>% 
  summarise(N = PointID %>% unique() %>% length,
            m = AB %>% sum,
            E = m / N,
            .groups =  'drop') %>%
  group_by(Year) %>% 
  summarise(Mean_N = mean(N),
              Se_N =  se(N),
              Mean_m = mean(m),
              Se_m = se(m),
              Mean_E = mean(E) ,
              Se_E = se(E),
            .groups =  'drop') %>% 
  mutate_at(c('Se_N','Se_m','Se_E'), function(x)round(x,3)) %>% 
  mutate_at(c('Mean_N','Mean_m','Mean_E'), function(x)round(x,3)) 
```

調查資料的E
```{r}
summary__combine %>% 
  flextable()
```



縣市
```{r}
COUNT_combine_bb_outout <-
town_combine_bb %>% 
  group_by(COUNTYNAME) %>% 
  summarise(樣點數 = PointID %>% unique() %>% length,
            筆數 = PointID  %>% length,
            '猴群數' = AB %>% sum ) 


  
```


```{r}
summary_COUNT_combine <- 
town_combine_bb %>% 
  group_by(COUNTYNAME, Year, Survey) %>% 
  summarise(N = PointID %>% unique() %>% length,
            m = AB %>% sum,
            E = m / N,
            .groups =  'drop') %>%
  group_by(COUNTYNAME) %>% 
  summarise(Mean_N = mean(N),
              Se_N =  se(N),
              Mean_m = mean(m),
              Se_m = se(m),
              Mean_E = mean(E) ,
              Se_E = se(E),
            .groups =  'drop') %>% 
  mutate_at(c('Se_N','Se_m','Se_E'), function(x)round(x,3)) %>% 
  mutate_at(c('Mean_N','Mean_m','Mean_E'), function(x)round(x,3)) %>% 

  arrange(-Mean_E)
```

調查資料的E
```{r}
summary_COUNT_combine %>% 
  flextable()
```

```{r}

summary_COUNT_combine %>% 
  mutate(
    COUNTYNAME = sapply(COUNTYNAME,
                        function(x) paste(str_split(x, "")[[1]], collapse = "\n")),
    COUNTYNAME = reorder(COUNTYNAME, -Mean_E)) %>%
  
  ggplot(data = ., aes(COUNTYNAME, Mean_E))+
  geom_bar(aes(fill = -Mean_E), stat = "identity") +
  labs(x = "",y ="Encounter_rate")+
  scale_color_brewer(palette = "Set2")+
  theme_classic()+
  theme(
    text = element_text(size = 18),
        legend.position = "none")

```

藍色數字為平均樣區數
```{r}
COUNTY__sorted <- town_combine_bb %>% 
  group_by(COUNTYNAME, Year, Survey) %>% 
  summarise(N = PointID %>% unique() %>% length,
            m = AB %>% sum,
            .groups =  'drop') %>% setDT %>% 

   .[,Encounter_rate := m/N] %>% 
   .[, Mean_N := mean(N), by =  c('COUNTYNAME')] %>%
  .[, Mean_E := mean(Encounter_rate), by =  c('COUNTYNAME')] %>%
  arrange(desc(Mean_E)) %>% .$COUNTYNAME %>% unique()

town_nn <- 
lapply(COUNTY__sorted,
       function(x) paste(str_split(x, "")[[1]], collapse = "\n")) %>% unlist()



town_combine_bb %>% 
  group_by(COUNTYNAME, Year, Survey) %>% 
  summarise(N = PointID %>% unique() %>% length,
            m = AB %>% sum,
            .groups =  'drop') %>% setDT %>% 

   .[,Encounter_rate := m/N] %>% 
   .[, Mean_N := mean(N),   by =  c('COUNTYNAME')] %>% 
  
  ggplot(., aes(x = COUNTYNAME, y = Encounter_rate))+
  geom_boxplot(width = 0.3, linewidth = 0.4, fill= gray(.9))+
  stat_summary(fun = mean, geom = "text", 
               aes(label = round(Mean_N, 1)),
               hjust = 0,
               vjust = -7, color = "blue")+
  scale_x_discrete(limit = COUNTY__sorted , labels = town_nn)+
  scale_y_continuous(breaks = seq(0,0.2,0.05), limits = c(0,0.2))+
  labs(x = "", y = "Encounter_rate(群/樣點)")+
  theme(
    panel.border = element_rect(size = 1.5,fill = NA),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.text.x = element_text(size = 12,colour = "black", angle = 0),
    axis.text.y = element_text(size = 18,colour = "black"),
    axis.title = element_text(size = 18,colour = "black"),
    axis.title.y = element_text(angle = 270,
                                vjust = -1, hjust = 0.5),
    legend.position = "top"
  )
```



鄉鎮

```{r}
town_combine_bb_outout <- 
town_combine_bb %>% 
  group_by(COUNTYNAME,TOWNNAME, data_source) %>% 
  summarise(樣點數 = PointID %>% unique() %>% length,
            筆數 = PointID  %>% length,
            '猴群數' = AB %>% sum,
            .groups =  'drop' ) %>% 
  pivot_wider(., id_cols = c('COUNTYNAME','TOWNNAME'),
              names_from = 'data_source',
              values_from =c('樣點數', '筆數', '猴群數')) %>% 
  arrange(-`樣點數_BBS`) 

town_combine_bb_outout%>% 
  flextable()   %>% 
  colformat_double()  %>%
  separate_header()  %>% 
  align(align = "center", part = "all")  %>%
  valign(valign = "center", part = "header")  %>% 
  autofit()
```


```{r}
summary_TOWN_combine <- 
town_combine_bb %>% 
  group_by(COUNTYNAME,TOWNNAME, Year, Survey) %>% 
  summarise(N = PointID %>% unique() %>% length,
            m = AB %>% sum,
            E = m / N,
            .groups =  'drop') %>%
  group_by(COUNTYNAME,TOWNNAME) %>% 
  summarise(Mean_N = mean(N),
              Se_N =  se(N),
              Mean_m = mean(m),
              Se_m = se(m),
              Mean_E = mean(E) ,
              Se_E = se(E),
            .groups =  'drop') %>% 
  mutate_at(c('Se_N','Se_m','Se_E'), function(x)round(x,3)) %>% 
  mutate_at(c('Mean_N','Mean_m','Mean_E'), function(x)round(x,3)) %>% 

  arrange(-Mean_E)

```

調查資料的E  (前20名, 全部有186個鄉鎮)
```{r}
summary_TOWN_combine%>% 
  arrange(-Mean_E) %>% 
  slice(1:20) %>% 
  flextable()
```



```{r}

summary_TOWN_combine %>% 
  mutate(    
    TOWNNAME = sapply(TOWNNAME,
                        function(x) paste(str_split(x, "")[[1]], collapse = "\n")),
    TOWNNAME = reorder(TOWNNAME, -Mean_E)) %>% 
  filter(Mean_E>0) %>% 
  slice_max(order_by = Mean_E, n = 20) %>% 
  ggplot(data = , aes(TOWNNAME, Mean_E))+
  geom_bar(aes(fill = -Mean_E), stat = "identity") +
  #geom_col(aes(fill = -Mean_E))+
  labs(x = "",y ="Encounter_rate")+
  scale_color_brewer(palette = "Set2")+
  theme_classic()+
  theme(text = element_text(size = 18),
        legend.position = "none")

```

藍色數字為平均樣區數
```{r}
TOWN__sorted <- town_combine_bb %>%
  filter(str_detect(TOWNNAME, "大埔|番路|阿里山|古坑|林內")) %>% 
  group_by(TOWNNAME, Year, Survey) %>% 
  summarise(N = PointID %>% unique() %>% length,
            m = AB %>% sum,
            .groups =  'drop') %>% setDT %>% 

   .[,Encounter_rate := m/N] %>% 
   .[, .(Mean_N = mean(N),
         Mean_E = mean(Encounter_rate)), by =  c('TOWNNAME')] %>%
#  slice_max(order_by = Mean_E, n = 50) %>% 
  arrange(desc(Mean_E)) %>% .$TOWNNAME %>% unique()

town_nn2 <- 
lapply(TOWN__sorted,
       function(x) paste(str_split(x, "")[[1]], collapse = "\n")) %>% unlist()




town_combine_bb %>% 
  filter(str_detect(TOWNNAME, "大埔|番路|阿里山|古坑|林內")) %>% 
  group_by(TOWNNAME, Year, Survey) %>% 
  summarise(N = PointID %>% unique() %>% length,
            m = AB %>% sum,
            .groups =  'drop') %>% setDT %>% 

   .[,Encounter_rate := m/N] %>% 
   .[, Mean_N := mean(N),   by =  c('TOWNNAME')] %>% 
  
  ggplot(., aes(x = TOWNNAME, y = Encounter_rate))+
  geom_boxplot(width = 0.3, linewidth = 0.4, fill= gray(.9))+
  stat_summary(fun = mean, geom = "text", 
               aes(label = round(Mean_N, 1)),
               hjust = 0,
               vjust = -9, color = "blue")+
  scale_x_discrete(limit = TOWN__sorted , labels = town_nn2)+
  # scale_y_continuous(breaks = seq(0,0.2,0.05), limits = c(0,0.2))+
  labs(x = "", y = "Encounter_rate(群/樣點)")+
  theme(
    panel.border = element_rect(size = 1.5,fill = NA),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.text.x = element_text(size = 18,colour = "black", angle = 0),
    axis.text = element_text(size = 20,colour = "black"),
    axis.title = element_text(size = 18,colour = "black"),
    axis.title.y = element_text(angle = 270,
                                vjust = -1, hjust = 0.5),
    legend.position = "top"
  )
```




\newpage

# **BBS與林業署的資料 (用1:1混和)**


```{r echo=FALSE}
#bootstrap-------------------------
bb_all<- town_combine_bb %>% setDT %>% 
  .[,list(Year, AB, COUNTYNAME,TOWNNAME, data_source)] 

```


海拔50m以上的森林總面積=21028.14 (km^2^)\
方法：bootstrap\
重複抽樣：10,000次\
單位面積的半徑: 100m

```{r include=FALSE}

#重複抽樣10000次----
bootstrap_AB_all <- 
bb_all %>% 
  split(., .$Year) %>% 
  lapply(., function(x){
    replicate(10000, mean(sample(x$AB, replace = TRUE), na.rm = T)) 
  })%>% 
  lapply(., function(x){
    data.frame(
    'q_1' = quantile(x, probs = 0.025),
     'mm' = mean(x),
    'q_3' = quantile(x, probs = 0.975)
    )
  }) %>% 
  bind_rows(.id = 'Year') %>% 
  mutate('Year'  = as.integer(Year))


  row.names(bootstrap_AB_all) <- NULL
     


```

海拔50m以上的森林總面積=21028.14 (km^2^)\
方法：bootstrap\
重複抽樣：10,000次\
單位面積的半徑: 100m
```{r echo=FALSE}
per_Area <- (0.1*0.1*pi)   #100m半徑的單位原面積

troop_M_all <- 
 bootstrap_AB_all %>%
   setDT %>% 
   .[ , 'M_troops' := (21028.14/per_Area)*mm] %>% 
  .[ , 'q1_troops' := (21028.14/per_Area)*q_1] %>% 
  .[ , 'q3_troops' := (21028.14/per_Area)*q_3] %>% 
  .[, 'log_troops':= log(M_troops)]%>% 
  .[ , 'COUNT' := M_troops*25] 


```


```{r}
troop_M_all  %>% 
  mutate('年' = as.character(Year)) %>% 
  mutate(
    '相對密度' = round(mm,3),
    "相對密度(95%CI)" = paste0(round(q_1,3), "~", round(q_3,3))
  ) %>% 
  mutate(
    '群數' = round(M_troops),
    "群數(95%CI)" = paste0(round(q1_troops), "~", round(q3_troops))
  ) %>% 
  mutate(
    '隻數' = round(M_troops*25),
    "隻數(95%CI)" = paste0(round(q1_troops*25), "~", round(q3_troops*25))
    ) %>% 
  select(年, `相對密度`:`隻數(95%CI)`) %>% 
  flextable::flextable() 
```

```{r echo=FALSE}

ggplot(troop_M_all, aes(x = Year, y = M_troops))+
  geom_point()+
  geom_errorbar(aes(ymin = q1_troops,
                    ymax = q3_troops),width=0.1)+
  geom_text(data = troop_M_all, 
            aes(y = M_troops,
                label = as.integer(M_troops)),
            size = 4.5,
            hjust = -0.1, 
            vjust = -1,
            position = position_dodge(0.9), show.legend = F)+
  
  scale_y_continuous(breaks = seq(0,27500,5000), limits = c(0,28000))+

  labs(x = "",y = "猴群數(95%CI)")+

  theme_classic()+
  theme(
    panel.border = element_rect(linewidth = 1.5,fill = NA),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.text = element_text(size = 18,colour = "black"),
    axis.title = element_text(size = 18,colour = "black"),
    axis.title.y = element_text(angle = 270,
                              vjust = 0, hjust = 0.5),
    legend.position = "top"
  )

```



```{r}

troop_M_all%>%
write_xlsx(
.,
  here("./Report of Foresty_20251127/合併估算/年的相對密度_bootstrap.xlsx")
) 
  

```




估計**縣市**猴群數 
50m以上的森林，2021-2024的資料bootstraps


```{r include=FALSE}

#重複抽樣10000次----
bootstrap_AB_all_COUNTY <- 
bb_all %>% 
  split(., .$COUNTYNAME) %>% 
  lapply(., function(x){
    replicate(10000, mean(sample(x$AB, replace = TRUE), na.rm = T)) 
  })%>% 
  lapply(., function(x){
    data.frame(
    'q_1' = quantile(x, probs = 0.025),
     'mm' = mean(x),
    'q_3' = quantile(x, probs = 0.975)
    )
  }) %>% 
  bind_rows(.id = 'COUNTYNAME') 


  row.names(bootstrap_AB_all_COUNTY) <- NULL


```



海拔50m以上的森林在各縣市面積 (km^2^)\
方法：bootstrap\
重複抽樣：10,000次\
單位面積的半徑: 100m



```{r}
per_Area <- (0.1*0.1*pi)   #100m半徑的單位原面積

COUNTY_M_all <- 
  forest_town %>% 
  .[, .(area = sum(area)), by = 'COUNTYNAME'] %>% 
  left_join(bootstrap_AB_all_COUNTY, .,by = 'COUNTYNAME') %>% setDT %>% 
  .[ , 'M_troops' := (area/per_Area)*mm] %>% 
  .[ , 'q1_troops' := (area/per_Area)*q_1] %>% 
  .[ , 'q3_troops' := (area/per_Area)*q_3] %>% 
  .[, 'log_troops':= log(M_troops)]%>% 
  .[ , 'COUNT' := M_troops*25]  


```

用縣市的資料分別抽樣，再依各縣市50m以上的森林面積，去估算


```{r echo=FALSE}
COUNTY_M_all %>% 
  mutate(
    '相對密度' = round(mm,3),
    "相對密度(95%CI)" = paste0(round(q_1,3), "~", round(q_3,3))
  ) %>% 
  mutate(
    '群數' = round(M_troops),
    "群數(95%CI)" = paste0(round(q1_troops), "~", round(q3_troops))
  ) %>% 
  mutate(
    '隻數' = round(M_troops*25),
    "隻數(95%CI)" = paste0(round(q1_troops*25), "~", round(q3_troops*25))
    ) %>% 
  select(COUNTYNAME, `相對密度`:`隻數(95%CI)`) %>% arrange(-群數) %>% 
  flextable::flextable() 
```

```{r echo=FALSE}
COUNTY_M_all_sorted <- COUNTY_M_all %>%
  arrange(desc(M_troops)) %>% .$COUNTYNAME

COUNTY_nn <- 
lapply(COUNTY_M_all_sorted,
       function(x) paste(str_split(x, "")[[1]], collapse = "\n")) %>% unlist()


COUNTY_M_all %>%
ggplot(., aes(x = COUNTYNAME, y = M_troops))+
  geom_point()+
  geom_errorbar(aes(ymin = q1_troops,
                    ymax = q3_troops),width=0.1)+
  geom_text(data = COUNTY_M_all, 
            aes(y = M_troops,
                label = as.integer(M_troops)),
            size = 4.5,
            hjust = -0.1, 
            vjust = -1,
            position = position_dodge(0.9), show.legend = F)+
  scale_x_discrete(limit = COUNTY_M_all_sorted, label = COUNTY_nn )+
  scale_y_continuous(breaks = seq(0,9000,1000), limits = c(0,9000))+

  labs(x = "",y = "猴群數(95%CI)")+

  theme_classic()+
  theme(
    axis.text.x = element_text(angle = 0),
    panel.border = element_rect(linewidth = 1.5,fill = NA),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.text = element_text(size = 14,colour = "black"),
    axis.title = element_text(size = 18,colour = "black"),
    axis.title.y = element_text(angle = 270,
                              vjust = 0, hjust = 0.5),
    legend.position = "top"
  )
```



```{r}
list(
 '筆數' = COUNT_combine_bb_outout,
 '相對密度' =  summary_COUNT_combine,
 'bootstrap' =  COUNTY_M_all)%>%
write_xlsx(
.,
  here("./Report of Foresty_20251127/合併估算/縣市的調查相對密度.xlsx")
)
 
```



估計**部分鄉鎮**猴群數 
50m以上的森林，2021-2024的資料bootstraps

大埔,番路,阿里山,古坑,林內

```{r include=FALSE}

#重複抽樣10000次----
bootstrap_AB_all_TOWN <- 
bb_all %>% 
  filter(str_detect(TOWNNAME, "大埔|番路|阿里山|古坑|林內")) %>% 
  split(., .$TOWNNAME) %>% 
  lapply(., function(x){
    replicate(10000, mean(sample(x$AB, replace = TRUE), na.rm = T)) 
  })%>% 
  lapply(., function(x){
    data.frame(
    'q_1' = quantile(x, probs = 0.025),
     'mm' = mean(x),
    'q_3' = quantile(x, probs = 0.975)
    )
  }) %>% 
  bind_rows(.id = 'TOWNNAME') 


  row.names(bootstrap_AB_all_TOWN) <- NULL


```

```{r}
per_Area <- (0.1*0.1*pi)   #100m半徑的單位原面積

TOWN_M_all <- 
  forest_town %>% 
  left_join(bootstrap_AB_all_TOWN, .,by = 'TOWNNAME') %>% setDT %>% 
  .[ , 'M_troops' := (area/per_Area)*mm] %>% 
  .[ , 'q1_troops' := (area/per_Area)*q_1] %>% 
  .[ , 'q3_troops' := (area/per_Area)*q_3] %>% 
  .[, 'log_troops':= log(M_troops)]%>% 
  .[ , 'COUNT' := M_troops*25] 


```


```{r echo=FALSE}
TOWN_M_all %>% 
  mutate(
    '相對密度' = round(mm,3),
    "相對密度(95%CI)" = paste0(round(q_1,3), "~", round(q_3,3))
  ) %>% 
  mutate(
    '群數' = round(M_troops),
    "群數(95%CI)" = paste0(round(q1_troops), "~", round(q3_troops))
  ) %>% 
  mutate(
    '隻數' = round(M_troops*25),
    "隻數(95%CI)" = paste0(round(q1_troops*25), "~", round(q3_troops*25))
    ) %>% 
  select(COUNTYNAME, TOWNNAME,`相對密度`:`隻數(95%CI)`) %>% arrange(-群數) %>% 
  flextable::flextable() 
```

```{r echo=FALSE}
TOWN_M_all_sorted <- TOWN_M_all %>%
  arrange(desc(M_troops)) %>% .$TOWNNAME

TOWN_nn_3 <- 
lapply(TOWN_M_all_sorted ,
       function(x) paste(str_split(x, "")[[1]], collapse = "\n")) %>% unlist()

TOWN_M_all %>%
ggplot(., aes(x = TOWNNAME, y = M_troops))+
  geom_point()+
  geom_errorbar(aes(ymin = q1_troops,
                    ymax = q3_troops),width=0.1)+
  geom_text(data = TOWN_M_all, 
            aes(y = M_troops,
                label = as.integer(M_troops)),
            size = 4.5,
            hjust = -0.7, 
            vjust = -1,
            position = position_dodge(0.9), show.legend = F)+
  scale_x_discrete(limit = TOWN_M_all_sorted, labels = TOWN_nn_3 )+
#  scale_y_continuous(breaks = seq(0,9000,1000), limits = c(0,9000))+

  labs(x = "",y = "猴群數(95%CI)")+

  theme_classic()+
  theme(
    axis.text.x = element_text(angle = 0),
    panel.border = element_rect(linewidth = 1.5,fill = NA),
    panel.grid = element_blank(),
    panel.background = element_blank(),
    axis.text = element_text(size = 20,colour = "black"),
    axis.title = element_text(size = 18,colour = "black"),
    axis.title.y = element_text(angle = 270,
                              vjust = 0, hjust = 0.5),
    legend.position = "top"
  )
```




```{r}
list(
 '筆數' = town_combine_bb_outout,
 '相對密度' =  summary_TOWN_combine,
 'bootstrap' =  TOWN_M_all)%>%
write_xlsx(
.,
  here("./Report of Foresty_20251127/合併估算/鄉鎮的調查相對密度.xlsx")
)
```

